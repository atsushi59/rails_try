<h1 class="text-3xl font-bold underline">Hello world!</h1>

<%= form_with url: search_path, method: :post, id: 'location_form' do |form| %>
    <div>
        <%= form.label :selected_transport, '交通手段' %>
        <%= form.select :selected_transport, [['車', '車'], ['公共交通機関', '電車']] %>
    </div>

    <div>
        <%= form.label :selected_time, '所要時間' %>
        <%= form.select :selected_time, [['30分', '45分'], ['1時間', '75分'], ['1時間30分', '105分'], ['2時間', '135分']] %>
        <%# 前に書かれているのがユーザーが選択する時間で後ろに書かれているのがcontrollerに渡す時間 %>
    </div>

    <div>
        <%= form.label :selected_age, '子供の年齢' %>
        <%= form.select :selected_age, [['幼児', '幼児'], ['園児', '園児'], ['小学生', '小学生']] %>
    </div>

    <div>
        <%= form.label :selected_activity, '活動タイプ' %>
        <%= form.select :selected_activity, [['外遊び場', '外遊び場'], ['室内遊び場', '室内遊び場'], ['レジャー施設', 'レジャー施設']] %>
    </div>

    <div>
        <%= form.hidden_field :address, id: 'hidden_address' %>
        <%# 隠しフィールド 画面上では表示されないが検索ボタンを押したタイミングでhidden_addressを取得（現在地） %>
        <%= form.submit '検索' %>
    </div>
<% end %>

<dialog id="my_modal_2" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg">検索中です</h3>
        <p class="py-4">しばらくお待ちください。</p>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button type="button" onclick="document.getElementById('my_modal_2').close()">閉じる</button>
    </form>
</dialog>

<script>
    function showPosition(position) {
        var lat = position.coords.latitude;
        var lng = position.coords.longitude;

        var geocoder = new google.maps.Geocoder();
        var latlng = { lat: parseFloat(lat), lng: parseFloat(lng) };

        geocoder.geocode({ 'location': latlng }, function(results, status) {
            if (status === 'OK' && results[0]) {
                var fullAddress = results[0].formatted_address;
                console.log(fullAddress);

                var address = fullAddress.replace(/日本、〒\d{3}-\d{4} /, '');
                console.log(address);

                document.getElementById('hidden_address').value = address;
                document.getElementById('location_form').submit();
            } else {
                window.alert('No results found or Geocoder failed due to: ' + status);
            }
        });
    }

    document.getElementById('location_form').addEventListener('submit', function(event) {
        if (!document.getElementById('hidden_address').value) {
            event.preventDefault();
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(showPosition);
            } else {
                console.log("ジオロケーションは利用できません");
            }
        }
    });

    document.addEventListener('DOMContentLoaded', function() {
        var form = document.getElementById('location_form');
        form.addEventListener('submit', function(event) {
            event.preventDefault();
            var modal = document.getElementById('my_modal_2');
            modal.showModal();
            form.submit();
        });
    });
</script>
